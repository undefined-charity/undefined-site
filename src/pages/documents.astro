---
import BaseLayout from "@components/base/BaseLayout.astro";
import PageHeader from "@components/common/PageHeader.astro";
import { readdirSync } from "node:fs";
import path from "node:path";

type DocumentLink = {
  fileName: string;
  href: string;
  label: string;
};

type MeetingEntry = {
  dateKey: string;
  formattedDate: string;
  kind: "Agenda" | "Minutes";
  link: DocumentLink;
};

type MeetingGroup = {
  dateKey: string;
  formattedDate: string;
  agenda?: DocumentLink;
  minutes?: DocumentLink;
};

const PUBLIC_DOCUMENTS_DIR = path.join(process.cwd(), "public", "documents");

function listPdfFiles(subdir: string) {
  const dir = path.join(PUBLIC_DOCUMENTS_DIR, subdir);
  try {
    return readdirSync(dir, { withFileTypes: true })
      .filter(
        (entry) =>
          (entry.isFile() || entry.isSymbolicLink()) &&
          entry.name.toLowerCase().endsWith(".pdf"),
      )
      .map((entry) => entry.name);
  } catch {
    return [];
  }
}

function publicPdfHref(subdir: string, fileName: string) {
  return `/documents/${subdir}/${encodeURIComponent(fileName)}`;
}

function parseMeetingEntry(fileName: string): MeetingEntry | null {
  const match = fileName.match(
    /^(\d{4})-(\d{2})-(\d{2})-(Agenda|Minutes)\.pdf$/i,
  );
  if (!match) return null;

  const year = Number.parseInt(match[1] ?? "", 10);
  const month = Number.parseInt(match[2] ?? "", 10);
  const day = Number.parseInt(match[3] ?? "", 10);
  const kind = (match[4] ?? "").toLowerCase() === "minutes" ? "Minutes" : "Agenda";

  const date = new Date(Date.UTC(year, month - 1, day));
  const formattedDate = new Intl.DateTimeFormat("en-US", {
    month: "short",
    day: "2-digit",
    year: "numeric",
    timeZone: "UTC",
  }).format(date);

  return {
    dateKey: `${match[1]}-${match[2]}-${match[3]}`,
    formattedDate,
    kind,
    link: {
      fileName,
      href: publicPdfHref("meetings", fileName),
      label: `${kind} PDF`,
    },
  };
}

function buildMeetingGroups() {
  const files = listPdfFiles("meetings");
  const groupsMap = new Map<string, MeetingGroup>();
  const otherDocs: DocumentLink[] = [];

  for (const fileName of files) {
    const entry = parseMeetingEntry(fileName);
    if (!entry) {
      otherDocs.push({
        fileName,
        href: publicPdfHref("meetings", fileName),
        label: fileName.replace(/\.pdf$/i, ""),
      });
      continue;
    }

    const group =
      groupsMap.get(entry.dateKey) ?? {
        dateKey: entry.dateKey,
        formattedDate: entry.formattedDate,
      };

    if (entry.kind === "Agenda") {
      group.agenda = entry.link;
    } else {
      group.minutes = entry.link;
    }

    groupsMap.set(entry.dateKey, group);
  }

  const groups = Array.from(groupsMap.values()).sort((a, b) =>
    b.dateKey.localeCompare(a.dateKey),
  );

  return {
    groups,
    otherDocs: otherDocs.sort((a, b) => b.fileName.localeCompare(a.fileName)),
  };
}

function format990Document(fileName: string): { year: number; isMain: boolean; label: string } | null {
  const match = fileName.match(/^(\d{4})\s+990EZ(?:\s+schedule-([a-z]))?\.pdf$/i);
  if (!match) return null;

  const year = Number.parseInt(match[1] ?? "", 10);
  const schedule = (match[2] ?? "").toUpperCase();
  const isMain = !schedule;
  const label = isMain ? `${year} Form 990-EZ` : `${year} Schedule ${schedule}`;

  return { year, isMain, label };
}

function form990Documents() {
  const files = listPdfFiles("files");
  const docs = files
    .map((fileName) => {
      const parsed = format990Document(fileName);
      if (!parsed) return null;
      return {
        fileName,
        href: publicPdfHref("files", fileName),
        label: parsed.label,
        year: parsed.year,
        isMain: parsed.isMain,
      };
    })
    .filter((doc): doc is (DocumentLink & { year: number; isMain: boolean }) => Boolean(doc));

  return docs
    .sort((a, b) => b.year - a.year || Number(b.isMain) - Number(a.isMain) || a.label.localeCompare(b.label))
    .map(({ fileName, href, label }) => ({ fileName, href, label }));
}

function insuranceDocuments(): DocumentLink[] {
  const files = listPdfFiles("files").filter((fileName) =>
    fileName.toLowerCase().startsWith("insurancepolicy"),
  );

  const docs = files.map((fileName) => {
    const lower = fileName.toLowerCase();
    const label =
      lower === "insurancepolicy.pdf"
        ? "Insurance Policy"
        : lower.includes("pan eros")
          ? "Insurance Policy (Pan Eros)"
          : lower.includes("ammendment") || lower.includes("amendment")
            ? "Insurance Policy Amendment"
            : fileName.replace(/\.pdf$/i, "");

    return {
      fileName,
      href: publicPdfHref("files", fileName),
      label,
    };
  });

  const priorityOrder = [
    "Insurance Policy",
    "Insurance Policy Amendment",
    "Insurance Policy (Pan Eros)",
  ];

  return docs.sort((a, b) => {
    const aIndex = priorityOrder.indexOf(a.label);
    const bIndex = priorityOrder.indexOf(b.label);
    const aRank = aIndex === -1 ? Number.POSITIVE_INFINITY : aIndex;
    const bRank = bIndex === -1 ? Number.POSITIVE_INFINITY : bIndex;

    return aRank - bRank || a.label.localeCompare(b.label);
  });
}

const meetingData = buildMeetingGroups();
const meetingGroups = meetingData.groups;
const meetingOtherDocs = meetingData.otherDocs;
const form990Docs = form990Documents();
const insuranceDocs = insuranceDocuments();

const lastUpdated = new Intl.DateTimeFormat("en-US", {
  month: "long",
  year: "numeric",
}).format(new Date());
---

<BaseLayout
  title="Organizational Documents"
  description="Official documents and transparency information for Undefined, a 501(c)(3) nonprofit organization"
>
  <PageHeader title="Organizational Documents" />
  <section class="section">
    <div class="container">
      <div class="row justify-center">
        <div class="lg:col-10">
          <div
            class="glass rounded-lg p-8 mb-8 intersect:animate-fadeUp opacity-0"
          >
            <h2 class="h3 mb-6">Organization Information</h2>
            <div class="row">
              <div class="md:col-6 mb-6">
                <h3 class="h4 mb-4">Key Details</h3>
                <ul class="space-y-2">
                  <li><strong>Legal Name:</strong> Undefined</li>
                  <li><strong>Tax ID (EIN):</strong> 33-3432965</li>
                  <li><strong>UBI:</strong> 605 729 334</li>
                  <li><strong>Formation Date:</strong> February 2, 2025</li>
                  <li><strong>State of Incorporation:</strong> Washington</li>
                </ul>
              </div>

              <div class="md:col-6 mb-6">
                <h3 class="h4 mb-4">Contact Information</h3>
                <div class="mb-4">
                  <strong>Mailing Address:</strong><br />
                   119 1st Ave NW #370<br />
                   Ephrata, WA 98823<br />
                   United States
                </div>
                <div class="mb-4">
                  <strong>Service Address:</strong><br />
                   4301 Martin Rd<br />
                   Ephrata, WA 98823<br />
                   United States
                </div>
                <ul class="space-y-2">
                  <li>
                    <strong>Email:</strong>
                    <a
                      href="mailto:contact@undefined.charity"
                      class="text-blue-600 hover:underline"
                      >contact@undefined.charity</a
                    >
                  </li>
                  <li><strong>Phone:</strong> +1-206-580-4666</li>
                  <li>
                    <strong>Website:</strong>
                    <a
                      href="https://undefined.charity"
                      class="text-blue-600 hover:underline">undefined.charity</a
                    >
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <div
            class="glass rounded-lg p-8 mb-8 intersect:animate-fade opacity-0"
          >
            <h2 class="h3 mb-6">Transparency & Documentation</h2>
            <p class="mb-8 text-lg">
              As a 501(c)(3) nonprofit organization, Undefined is committed to
              complete transparency in our operations. Below you'll find all of
              our official organizational documents, IRS filings, and governance
              materials.
            </p>

            <div class="row">
              <div class="md:col-12 mb-8">
                <div class="glass-t rounded-lg p-6">
                  <h3 class="h4 mb-4">üìÑ IRS Documents & Tax-Exempt Status</h3>

                  <div class="mb-6">
                    <h4 class="h5 mb-3">501(c)(3) Determination Letter</h4>
                    <p class="mb-3">
                      Our official tax-exempt status determination from the
                      Internal Revenue Service.
                    </p>
                    <ul class="list-disc pl-6 mb-4">
                      <li>
                        <strong>Status:</strong> Tax-exempt under Internal
                        Revenue Code Section 501(c)(3)
                      </li>
                      <li><strong>EIN:</strong> 33-3432965</li>
                      <li><strong>Date:</strong> February 14, 2025</li>
                    </ul>
                    <a
                      href="/documents/files/FinalLetter_33-3432965_UNDEFINED_02142025_00.pdf"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-block px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                    >
                      üìÑ View IRS Final Determination Letter
                    </a>
                  </div>

                  <div class="mb-6">
                    <h4 class="h5 mb-3">Form 1023-EZ Application</h4>
                    <p class="mb-3">
                      Our original application for tax-exempt status filed with
                      the IRS.
                    </p>
                    <p class="mb-3 text-sm">
                      <strong>Description:</strong> Application for Recognition
                      of Exemption Under Section 501(c)(3)
                    </p>
                    <a
                      href="/documents/files/1023-EZ_Submission.pdf"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-block px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                    >
                      üìÑ View 1023-EZ Submission
                    </a>
                  </div>

                  <div class="mb-6">
                    <h4 class="h5 mb-3">IRS Notices & State Documents</h4>
                    <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                      <div class="text-center">
                        <a
                          href="/documents/files/CP575Notice_1739495863893.pdf"
                          target="_blank"
                          rel="noopener noreferrer"
                          class="inline-block px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                        >
                          üìÑ IRS CP575 Notice
                        </a>
                      </div>
                      <div class="text-center">
                        <a
                          href="/documents/files/0021692540_Certificate.pdf"
                          target="_blank"
                          rel="noopener noreferrer"
                          class="inline-block px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                        >
                          üìÑ WA State Certificate
                        </a>
                      </div>
                      <div class="text-center">
                        <a
                          href="/documents/files/0021692540_OnlineReport.pdf"
                          target="_blank"
                          rel="noopener noreferrer"
                          class="inline-block px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                        >
                          üìÑ WA State Formation Document
                        </a>
                      </div>
                      <div class="text-center">
                        <a
                          href="/documents/files/Resale%20Permit.pdf"
                          target="_blank"
                          rel="noopener noreferrer"
                          class="inline-block px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                        >
                          üìÑ WA Resale Permit
                        </a>
                      </div>
                    </div>
                  </div>

                  {
                    form990Docs.length > 0 && (
                      <div class="mb-6">
                        <h4 class="h5 mb-3">Form 990-EZ & Schedules</h4>
                        <p class="mb-3">
                          Our IRS Form 990-EZ filing and supporting schedules.
                        </p>
                        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                          {form990Docs.map((doc) => (
                            <div class="text-center">
                              <a
                                href={doc.href}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="inline-block px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors"
                              >
                                üìÑ {doc.label}
                              </a>
                            </div>
                          ))}
                        </div>
                      </div>
                    )
                  }

                  {
                    insuranceDocs.length > 0 && (
                      <div class="mb-2">
                        <h4 class="h5 mb-3">Insurance</h4>
                        <p class="mb-3">
                          Insurance policy documentation and amendments.
                        </p>
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                          {insuranceDocs.map((doc) => (
                            <div class="text-center">
                              <a
                                href={doc.href}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="inline-block px-4 py-2 bg-amber-600 text-white rounded hover:bg-amber-700 transition-colors"
                              >
                                üìÑ {doc.label}
                              </a>
                            </div>
                          ))}
                        </div>
                      </div>
                    )
                  }
                </div>
              </div>
            </div>
          </div>

          <div
            class="glass rounded-lg p-8 mb-8 intersect:animate-fadeUp opacity-0"
          >
            <h2 class="h3 mb-6">üì¢ Marketing Materials</h2>
            <p class="mb-6 text-lg">
              Download our logo, letterhead, and marketing materials for
              community use, event promotion, and partnerships. These assets are
              available for community partners, collaborators, and media use.
            </p>

            <div class="row">
              <div class="md:col-6 mb-6">
                <div class="glass-t rounded-lg p-6">
                  <h3 class="h4 mb-4">üé® Logo Assets</h3>
                  <p class="mb-4">
                    Official Undefined logos in different formats and sizes. Use
                    these for event promotion, social media, and partnership
                    materials.
                  </p>

                  <div class="space-y-4">
                    <div
                      class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded"
                    >
                      <div>
                        <strong>Vector Logo (SVG)</strong>
                        <br />
                        <span class="text-sm text-gray-600 dark:text-gray-400"
                          >Scalable vector - Perfect for web, apps, any size</span
                        >
                      </div>
                      <a
                        href="/documents/logo.svg"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm"
                      >
                        Download
                      </a>
                    </div>

                    <div
                      class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded"
                    >
                      <div>
                        <strong>High Resolution PNG</strong>
                        <br />
                        <span class="text-sm text-gray-600 dark:text-gray-400"
                          >1.3MB PNG - For print materials, large displays</span
                        >
                      </div>
                      <a
                        href="/documents/logo.png"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm"
                      >
                        Download
                      </a>
                    </div>

                    <div
                      class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded"
                    >
                      <div>
                        <strong>Source File (Adobe Illustrator)</strong>
                        <br />
                        <span class="text-sm text-gray-600 dark:text-gray-400"
                          >AI file - For designers and professional printing</span
                        >
                      </div>
                      <a
                        href="/documents/logo.ai"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm"
                      >
                        Download
                      </a>
                    </div>

                    <div
                      class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded"
                    >
                      <div>
                        <strong>Source File (Photoshop)</strong>
                        <br />
                        <span class="text-sm text-gray-600 dark:text-gray-400"
                          >PSD file - For raster editing and design work</span
                        >
                      </div>
                      <a
                        href="/documents/logo.psd"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm"
                      >
                        Download
                      </a>
                    </div>

                    <div
                      class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded"
                    >
                      <div>
                        <strong>Letterhead Template (.dotx)</strong>
                        <br />
                        <span class="text-sm text-gray-600 dark:text-gray-400"
                          >Microsoft Word template for official correspondence</span
                        >
                      </div>
                      <a
                        href="/documents/files/letterhead.dotx"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm"
                      >
                        Download
                      </a>
                    </div>
                  </div>
                </div>
              </div>

              <div class="md:col-6 mb-6">
                <div class="glass-t rounded-lg p-6">
                  <h3 class="h4 mb-4">üìã Usage Guidelines</h3>
                  <p class="mb-4">
                    Our marketing materials are available for appropriate use
                    by:
                  </p>
                  <ul class="list-disc pl-6 mb-4 space-y-1">
                    <li>Community partners and collaborators</li>
                    <li>Event organizers featuring our programs</li>
                    <li>Media and press coverage</li>
                    <li>Educational and non-commercial use</li>
                    <li>Nonprofit organizations and allies</li>
                  </ul>

                  <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                    <p class="text-sm">
                      <strong>Need help?</strong> For questions about logo
                      usage, additional formats, or permission for commercial
                      use, contact us at
                      <a
                        href="mailto:contact@undefined.charity"
                        class="text-blue-600 hover:underline"
                      >
                        contact@undefined.charity
                      </a>
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-6 text-center">
              <a
                href="/documents/README.md"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-block px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
              >
                üìÑ View Complete Usage Guidelines
              </a>
            </div>
          </div>

          <div class="glass rounded-lg p-8 intersect:animate-fadeUp opacity-0">
            <h2 class="h3 mb-6">Governance Documents</h2>
            <p class="mb-6">
              Board meeting materials are posted here for public reference.
            </p>

            <h3 class="h4 mb-4">üóìÔ∏è Meeting Agendas & Minutes</h3>
            {
              meetingGroups.length > 0 ? (
                <div class="space-y-4 mb-8">
                  {meetingGroups.map((group) => (
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded">
                      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                        <div>
                          <strong>{group.formattedDate}</strong>
                          <br />
                          <span class="text-sm text-gray-600 dark:text-gray-400">
                            Board meeting materials
                          </span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                          {group.agenda ? (
                            <a
                              href={group.agenda.href}
                              target="_blank"
                              rel="noopener noreferrer"
                              class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm"
                            >
                              {group.agenda.label}
                            </a>
                          ) : (
                            <span class="text-sm text-gray-600 dark:text-gray-400">
                              Agenda pending
                            </span>
                          )}
                          {group.minutes ? (
                            <a
                              href={group.minutes.href}
                              target="_blank"
                              rel="noopener noreferrer"
                              class="px-3 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 transition-colors text-sm"
                            >
                              {group.minutes.label}
                            </a>
                          ) : (
                            <span class="text-sm text-gray-600 dark:text-gray-400">
                              Minutes pending
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <p class="mb-8 text-sm text-gray-600 dark:text-gray-400">
                  <em>No meeting agendas or minutes have been posted yet.</em>
                </p>
              )
            }

            {
              meetingOtherDocs.length > 0 && (
                <div class="mb-8">
                  <h4 class="h5 mb-3">Other Meeting Documents</h4>
                  <div class="space-y-2">
                    {meetingOtherDocs.map((doc) => (
                      <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded">
                        <div>
                          <strong>{doc.label}</strong>
                          <br />
                          <span class="text-sm text-gray-600 dark:text-gray-400">
                            {doc.fileName}
                          </span>
                        </div>
                        <a
                          href={doc.href}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm"
                        >
                          View PDF
                        </a>
                      </div>
                    ))}
                  </div>
                </div>
              )
            }

            <h3 class="h4 mb-4">Questions or Requests</h3>
            <p class="mb-6">
              If you have questions about any of these documents or need
              additional information for grant applications, donations, or other
              purposes, please contact us at
              <a
                href="mailto:contact@undefined.charity"
                class="text-blue-600 hover:underline"
                >contact@undefined.charity</a
              >.
            </p>

            <div class="text-center">
              <a
                href="/contact"
                class="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold"
              >
                Contact Us
              </a>
            </div>

            <hr class="my-6" />
            <p class="text-sm text-txt-s dark:text-darkmode-txt-s text-center">
              <em
                >This page is updated regularly to ensure all current documents
                are available to the public. Last updated: {lastUpdated}</em
              >
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>
